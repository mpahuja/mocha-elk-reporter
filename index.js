var Base = require("mocha").reporters.Base;
var postTestData = require('./src/elastic-search');

exports = module.exports = ELKReporter;

/**
 * Initialize a new `ELK` reporter.
 *
 * @api public
 * @param {Runner} runner
 */
function ELKReporter(runner) {
  Base.call(this, runner);

  var self = this;
  var tests = [];
  var pending = [];
  var failures = [];
  var passes = [];
  var passesCount = 0;
  var failuresCount = 0;
  var pendingCount = 0;

  runner.on('test end', function(test) {
    tests.push(test);
  });

  runner.on('pass', function(test) {
    passesCount++;
    passes.push(test);
  });

  runner.on('fail', function(test) {
    failuresCount++;
    failures.push(test);
  });

  runner.on('pending', function(test) {
    pendingCount++;
    pending.push(test);
  });

  runner.on('end', function() {
      /*
      * When Cypress test passes, it provides a test instance to add context using mochawesome/addContext.
      * But when Cypress test fails, it does not provide test instance to add context.
      * However it provides test instance when that specific test finishes.
      * So to add context on test failure, replace test objects in 'failures' array with its equivalent object from 'tests' array.
      * 
      * 1. Iterate over failures array. Push failed tests with no context in a map by mapping title to test's index in failures array.
      * 2. Iterate over tests array, if map has that test title, replace the test object in failures with its equivalent in tests array.
      *
      * e.g. tests array - 
      * [
      *   Test { title: '[uuid:cy-template-00001], should do first thing', state: 'passed', context: {title: 'some string', value: {shopperId: '1111'}}, .....},
      *   Test { title: '[uuid:cy-template-00002], should do second thing', state: 'failed', context: {title: 'some string', value: {shopperId: '1111'}}, .....},
      *   Test { title: '[uuid:cy-template-00003], should do third thing', state: 'passed', context: {title: 'some string', value: {shopperId: '1111'}}, .....},
      *   Test { title: '[uuid:cy-template-00004], should do fourth thing', state: 'failed', context: {title: 'some string', value: {shopperId: '1111'}}, .....}
      * ]
      * 
      * e.g. failures array - 
      * Note: it does not have context property on it, but rest of the properties are same as above
      * [
      *   {title: '[uuid:cy-template-00002], should do second thing', .....},
      *   {title: '[uuid:cy-template-00004], should do fourth thing', .....},
      * ]
      * 
      * e.g. failuresToIndex map -
      * { 
      *  '[uuid:cy-template-00002], should do second thing' => 2,
      *  '[uuid:cy-template-00004], should do fourth thing' => 3 
      * }
      * 
      * e.g. after replacing test objects, failures array -
      * { 
      *   Test { title: '[uuid:cy-template-00002], should do second thing', state: 'failed', context: {title: 'some string', value: {shopperId: '1111'}}, .....},
      *   Test { title: '[uuid:cy-template-00004], should do fourth thing', state: 'failed', context: {title: 'some string', value: {shopperId: '1111'}}, .....}
      * }
      */
    if (failures.length) {
     let failuresToIndex = new Map();

      failures.forEach((failedTest, index) => {
        if (!failedTest.context) {
          failuresToIndex.set(failedTest.title, index);
        }
      });

      if (failuresToIndex.size) {
        tests.forEach(test => {
          if (failuresToIndex.has(test.title)) {
            const indexToReplace = failuresToIndex.get(test.title);
            failures[indexToReplace] = test;
          }
        });
      }
    }

    var obj = {
      stats: self.stats,
      tests: tests.map(clean),
      pending: pending.map(clean),
      failures: failures.map(clean),
      passes: passes.map(clean)
    };
    console.log('\n' + passesCount + ' passed','\n' + failuresCount + ' failed','\n' + pendingCount + ' pending','\n');
    runner.testResults = obj;
    postTestData(obj, function(err) {
      if(err) {
        console.log("********* ERROR GENERATED BY ELK-REPORTER *********");
        if(err.severity && err.severity === "high") {
          console.log("** SEVERE ERROR **");
          process.exit(-1);
        } else {
          console.log("** Non-severe error **");
        }
        console.log(err);
      }
    });
  });
}

/**
 * Return a plain-object representation of `test`
 * free of cyclic properties etc.
 *
 * @api private
 * @param {Object} test
 * @return {Object}
 */
function clean(test) {
  return {
    title: test.title,
    fullTitle: test.fullTitle(),
    duration: test.duration,
    err: errorJSON(test.err || {}),
    context: test.context
  };
}

/**
 * Transform `error` into a JSON object.
 *
 * @api private
 * @param {Error} err
 * @return {Object}
 */
function errorJSON(err) {
  var res = {};
  Object.getOwnPropertyNames(err).forEach(function(key) {
    res[key] = err[key];
  }, err);
  return res;
}
